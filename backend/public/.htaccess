# Manejo de peticiones OPTIONS (Preflight)
# Esto debe ir PRIMERO para interceptar la petición antes de cualquier otra cosa.
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # --- INICIO DE LA CORRECCIÓN ---
    # Capturar la cabecera 'Authorization' y pasarla a PHP.
    # Esto es necesario en algunas configuraciones de Apache.
    RewriteCond %{HTTP:Authorization} .
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
    # --- FIN DE LA CORRECCIÓN ---

    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ $1 [R=204,L]
</IfModule>

# Configuración de cabeceras CORS
# Se aplican a todas las peticiones, incluyendo las que no son OPTIONS.
<IfModule mod_headers.c>
    Header always set Access-Control-Allow-Origin "http://localhost:5173"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization"
    Header always set Access-Control-Allow-Credentials "true"
    Header always set Access-Control-Max-Age "86400"
</IfModule>

# Reglas del Front Controller (API)
# Esto se ejecuta DESPUÉS de haber manejado las peticiones OPTIONS.
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^api/(.*)$ index.php?url=$1 [QSA,L]
</IfModule>